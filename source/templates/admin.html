<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - PicHost</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/admin.css') }}">
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <div class="logo">
                <h2>üñºÔ∏è PicHost</h2>
                <span class="role">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
            </div>

            <nav class="nav">
                <a href="{{ url_for('index') }}">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                <a href="{{ url_for('profile') }}">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
                <a href="{{ url_for('admin_logs') }}">üìã –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</a>
                <button onclick="syncDatabase()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î</button>
                <a href="{{ url_for('logout') }}">üö™ –í—ã–π—Ç–∏</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                <div class="user-info">
                    <span>{{ (current_user.given_name + ' ' + current_user.family_name)|trim or current_user.name }}</span>
                </div>
            </header>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üìÑ –§–∞–π–ª–æ–≤ –≤ –ë–î</h3>
                    <p id="dbFilesCount">‚Äî</p>
                </div>
                <div class="stat-card">
                    <h3>üìÅ –ê–ª—å–±–æ–º–æ–≤</h3>
                    <p id="albumsCount">‚Äî</p>
                </div>
                <div class="stat-card">
                    <h3>üìù –ê—Ä—Ç–∏–∫—É–ª–æ–≤</h3>
                    <p id="articlesCount">‚Äî</p>
                </div>
                <div class="stat-card">
                    <h3>üìä –õ–æ–≥–æ–≤</h3>
                    <p id="logsCount">‚Äî</p>
                </div>
            </div>

            <div class="content-grid">
                <div class="card">
                    <h3>üíæ –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</h3>
                    <div class="disk-usage">
                        <div class="progress">
                            <div class="progress-bar" id="adminDiskBar"></div>
                        </div>
                        <div class="disk-info">
                            <p>–í—Å–µ–≥–æ: <span id="diskTotal">‚Äî</span></p>
                            <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: <span id="diskUsed">‚Äî</span></p>
                            <p>–°–≤–æ–±–æ–¥–Ω–æ: <span id="diskFree">‚Äî</span></p>
                            <p>–ó–∞–Ω—è—Ç–æ: <span id="diskPercent">‚Äî</span></p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üóÉÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                    <div class="db-info">
                        <p>–†–∞–∑–º–µ—Ä –ë–î: <span id="dbSize">‚Äî</span></p>
                        <p>–¢–∞–±–ª–∏—Ü: <span id="dbTables">‚Äî</span></p>
                        <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–π: <span id="dbConnections">‚Äî</span></p>
                        <p>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: <span id="dbUptime">‚Äî</span></p>
                    </div>
                </div>

                <div class="card">
                    <h3>üìã –¢–∞–±–ª–∏—Ü—ã –ë–î</h3>
                    <div id="tablesList"></div>
                </div>

                <div class="card">
                    <h3>üíª –°–∏—Å—Ç–µ–º–∞</h3>
                    <div class="system-info">
                        <p>Python: <span id="pythonVersion">‚Äî</span></p>
                        <p>Flask: <span id="flaskVersion">‚Äî</span></p>
                        <p>–°–µ—Ä–≤–µ—Ä: <span id="serverInfo">‚Äî</span></p>
                        <p>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: <span id="appUptime">‚Äî</span></p>
                    </div>
                </div>

                <div class="card">
                    <h3>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <div class="user-details">
                        <p>–õ–æ–≥–∏–Ω: <span>{{ current_user.name if current_user else '–ê–Ω–æ–Ω–∏–º' }}</span></p>
                        <p>–ü–æ–ª–Ω–æ–µ –∏–º—è: <span>{{ (current_user.given_name ~ ' ' ~ current_user.family_name).strip() if current_user.given_name or current_user.family_name else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</span></p>
                        <p>Email: <span>{{ current_user.email if current_user else 'N/A' }}</span></p>
                        <p>ID: <span>{{ current_user.sub if current_user else 'N/A' }}</span></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingDetails">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
        </div>
    </div>

    <script>
        async function syncDatabase() {
            showLoading('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î...');
            try {
                const response = await fetch('/api/sync');
                const data = await response.json();

                if (response.ok) {
                    alert(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n–£–¥–∞–ª–µ–Ω–æ: ${data.deleted}, –î–æ–±–∞–≤–ª–µ–Ω–æ: ${data.added}`);
                    loadAdminStats();
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
            hideLoading();
        }

        async function cleanupThumbnails() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–µ–≤—å—é?')) return;

            showLoading('–û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–≤—å—é...');
            try {
                await fetch('/api/cleanup-thumbnails/all', { method: 'POST' });
                alert('–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
            hideLoading();
        }

            async function loadAdminStats() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const statsResponse = await fetch('/api/stats');
                const statsData = await statsResponse.json();

                document.getElementById('dbFilesCount').textContent = statsData.files?.total_files?.toLocaleString() || '0';
                document.getElementById('albumsCount').textContent = statsData.files?.total_albums?.toLocaleString() || '0';

                const disk = statsData.disk_stats['/'] || Object.values(statsData.disk_stats)[0];
                if (disk) {
                    const percent = disk.percent_used || 0;
                    document.getElementById('adminDiskBar').style.width = percent + '%';
                    document.getElementById('diskPercent').textContent = percent + '%';
                    document.getElementById('diskTotal').textContent = formatBytes(disk.total);
                    document.getElementById('diskUsed').textContent = formatBytes(disk.used);
                    document.getElementById('diskFree').textContent = formatBytes(disk.free);
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ë–î (–≤–∫–ª—é—á–∞—è –∞—Ä—Ç–∏–∫—É–ª—ã –∏ –ª–æ–≥–∏)
                await loadDatabaseInfo();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        async function loadDatabaseInfo() {
            try {
                const response = await fetch('/api/admin/db-info');
                const data = await response.json();

                document.getElementById('dbSize').textContent = data.database_size || '‚Äî';
                document.getElementById('dbTables').textContent = data.tables_count || '‚Äî';
                document.getElementById('dbConnections').textContent = data.active_connections || '‚Äî';
                document.getElementById('dbUptime').textContent = data.uptime || '‚Äî';

                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –∏ –ª–æ–≥–æ–≤
                document.getElementById('articlesCount').textContent = data.total_articles?.toLocaleString() || '0';
                document.getElementById('logsCount').textContent = data.total_logs?.toLocaleString() || '0';

                const tablesList = document.getElementById('tablesList');
                tablesList.innerHTML = '';

                if (data.tables && data.tables.length > 0) {
                    data.tables.forEach(table => {
                        const div = document.createElement('div');
                        div.className = 'table-item';
                        div.innerHTML = `<strong>${table.name}</strong> (${table.rows || 0} –∑–∞–ø–∏—Å–µ–π, ${table.size || 'N/A'})`;
                        tablesList.appendChild(div);
                    });
                } else {
                    tablesList.innerHTML = '<div class="table-item">–ù–µ—Ç —Ç–∞–±–ª–∏—Ü</div>';
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ë–î:', error);
                document.getElementById('articlesCount').textContent = '‚Äî';
                document.getElementById('logsCount').textContent = '‚Äî';
            }
        }


        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/admin/system-info');
                const data = await response.json();

                document.getElementById('pythonVersion').textContent = data.python_version || '‚Äî';
                document.getElementById('flaskVersion').textContent = data.flask_version || '‚Äî';
                document.getElementById('serverInfo').textContent = data.server_info || '‚Äî';
                document.getElementById('appUptime').textContent = data.uptime || '‚Äî';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã:', error);
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showLoading(text) {
            document.getElementById('loadingDetails').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAdminStats();
            loadSystemInfo();
            setInterval(loadAdminStats, 120000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
        });
    </script>
</body>
</html>
